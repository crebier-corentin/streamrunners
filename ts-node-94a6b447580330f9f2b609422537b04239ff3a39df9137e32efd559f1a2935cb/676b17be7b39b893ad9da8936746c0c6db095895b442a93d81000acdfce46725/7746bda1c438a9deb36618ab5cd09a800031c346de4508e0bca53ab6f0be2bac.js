"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const StreamQueue_1 = require("../database/entity/StreamQueue");
const connection_1 = require("../database/connection");
const User_1 = require("../database/entity/User");
const throttle_debounce_1 = require("throttle-debounce");
const moment = require("moment");
var express = require('express');
var router = express.Router();
router.post('/update', (req, res) => __awaiter(this, void 0, void 0, function* () {
    const update = throttle_debounce_1.throttle(1000, () => {
        setImmediate(StreamQueue_1.updateStreamQueue);
    });
    update();
    function sendData() {
        return __awaiter(this, void 0, void 0, function* () {
            res.send({
                auth: true,
                points: req.user.points,
                queue: (yield StreamQueue_1.StreamQueue.currentAndNextStreams()),
                viewers: (yield User_1.User.viewers()),
                mostPoints: (yield User_1.User.mostPoints()),
                mostPlace: (yield User_1.User.mostPlace()),
            });
        });
    }
    if (req.isAuthenticated()) {
        //check if stream is online
        let current = yield StreamQueue_1.StreamQueue.currentStream();
        //Check if stream and is not self stream
        if (current == undefined || current.user.id === req.user.id) {
            yield sendData();
            return;
        }
        let isOnline = yield StreamQueue_1.StreamQueue.isCurrentOnline(current.user.username);
        //Check if stream is online
        if (!isOnline) {
            yield sendData();
            return;
        }
        let newDate = moment();
        let lastUpdate = req.user.lastUpdateTime();
        //If lastUpdate was one minutes or less ago
        if (moment(lastUpdate).add(1, "minutes") >= newDate) {
            yield req.user.changePoints((newDate.toDate().getTime() - lastUpdate.getTime()) / 1000);
            req.user.lastUpdate = newDate.toDate();
            yield req.user.save();
        }
        else {
            req.user.lastUpdate = newDate.toDate();
            yield req.user.save();
        }
        yield sendData();
        return;
    }
    else {
        //Not auth
        return res.send({ auth: false });
    }
}));
router.post('/add', (req, res) => __awaiter(this, void 0, void 0, function* () {
    if (req.isAuthenticated()) {
        //Check if queue is empty
        let cost = (yield StreamQueue_1.StreamQueue.isEmpty()) ? 0 : 1000;
        //Check if enough pointsFunc
        let points = (yield req.user.points);
        if (points < cost) {
            //No enough point
            res.send({ auth: true, enough: false, points, cost });
        }
        else {
            //Enough point
            let stream = new StreamQueue_1.StreamQueue();
            stream.amount = cost;
            stream.time = 60 * 10;
            stream.user = req.user;
            let repository = connection_1.getDBConnection().getRepository(StreamQueue_1.StreamQueue);
            yield repository.save(stream);
            req.user.streamQueue.push(stream);
            //Change points
            yield req.user.changePoints(-cost);
            //Discord
            (() => {
                //Stop spam, only one message per hour
                if (global['discordAntiSpamDate'] >= moment().subtract("1", "hour")) {
                    return;
                }
                global['discordAntiSpamDate'] = moment();
                const channel = req.discord.channels.find((ch) => ch.id === '617835840068124692');
                if (!channel)
                    return;
                channel['send'](`
  Un stream viens d'être lancé sur StreamRunners ! Va vite récupérer des points !
  https://streamrunners.fr/`);
            })();
            res.send({ auth: true, enough: true });
        }
    }
    else {
        //Not auth
        res.send({ auth: false });
    }
}));
router.post('/delete', (req, res) => __awaiter(this, void 0, void 0, function* () {
    if (req.isUnauthenticated()) {
        return res.send({ auth: false });
    }
    //Get id
    const id = req['body'].id;
    if (id == undefined) {
        return res.send({ auth: true, error: true, errorMessage: "Impossible de trouver la place" });
    }
    //Get stream
    const repo = connection_1.getDBConnection().getRepository(StreamQueue_1.StreamQueue);
    const stream = yield repo.createQueryBuilder("queue")
        .leftJoinAndSelect("queue.user", "user")
        .where("queue.id = :id", { id })
        .andWhere("user.id = :userid", { userid: req.user.id })
        .getOne();
    if (stream == undefined || stream.user.id !== req.user.id) {
        return res.send({ auth: true, error: true, errorMessage: "Impossible de trouver la place" });
    }
    if ((yield StreamQueue_1.StreamQueue.currentStream()).id === stream.id) {
        return res.send({ auth: true, error: true, errorMessage: "On ne peut pas supprimer si on à la première place" });
    }
    //Delete stream
    yield repo.remove(stream);
    //Refund
    yield req.user.changePoints(stream.amount);
    yield req.user.save();
    return res.send({ auth: true, error: false });
}));
router.post('/skip', (req, res) => __awaiter(this, void 0, void 0, function* () {
    if (req.isAuthenticated() && req.user.moderator) {
        let currentStream = yield StreamQueue_1.StreamQueue.currentStream();
        if (currentStream != undefined) {
            currentStream.current = currentStream.time;
            yield connection_1.getDBConnection().getRepository(StreamQueue_1.StreamQueue).save(currentStream);
        }
        res.send("Stream skippé");
    }
    else {
        res.status(403);
        res.send("Vous n'avez pas le droit de faire ça !");
    }
}));
module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL1N0cmVhbVJ1bm5lcnMvVHdpdGNoVmlldy9yb3V0ZXMvd2F0Y2gudHMiLCJzb3VyY2VzIjpbIi9TdHJlYW1SdW5uZXJzL1R3aXRjaFZpZXcvcm91dGVzL3dhdGNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSxnRUFBOEU7QUFFOUUsdURBQXVEO0FBQ3ZELGtEQUE2QztBQUM3Qyx5REFBMkM7QUFHM0MsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRWpDLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUNqQyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7QUFFOUIsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBTyxHQUFvQixFQUFFLEdBQUcsRUFBRSxFQUFFO0lBRXZELE1BQU0sTUFBTSxHQUFHLDRCQUFRLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRTtRQUMvQixZQUFZLENBQUMsK0JBQWlCLENBQUMsQ0FBQztJQUNwQyxDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sRUFBRSxDQUFDO0lBRVQsU0FBZSxRQUFROztZQUNuQixHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUNMLElBQUksRUFBRSxJQUFJO2dCQUNWLE1BQU0sRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU07Z0JBQ3ZCLEtBQUssRUFBRSxDQUFDLE1BQU0seUJBQVcsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO2dCQUNsRCxPQUFPLEVBQUUsQ0FBQyxNQUFNLFdBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDL0IsVUFBVSxFQUFFLENBQUMsTUFBTSxXQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBQ3JDLFNBQVMsRUFBRSxDQUFDLE1BQU0sV0FBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO2FBQ3RDLENBQUMsQ0FBQztRQUNQLENBQUM7S0FBQTtJQUVELElBQUksR0FBRyxDQUFD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T0FBTyxHQUFHLE1BQU0sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7U3RyZWFtUXVldWUsIHVwZGF0ZVN0cmVhbVF1ZXVlfSBmcm9tIFwiLi4vZGF0YWJhc2UvZW50aXR5L1N0cmVhbVF1ZXVlXCI7XG5pbXBvcnQge1JlcG9zaXRvcnl9IGZyb20gXCJ0eXBlb3JtXCI7XG5pbXBvcnQge2dldERCQ29ubmVjdGlvbn0gZnJvbSBcIi4uL2RhdGFiYXNlL2Nvbm5lY3Rpb25cIjtcbmltcG9ydCB7VXNlcn0gZnJvbSBcIi4uL2RhdGFiYXNlL2VudGl0eS9Vc2VyXCI7XG5pbXBvcnQge3Rocm90dGxlfSBmcm9tICd0aHJvdHRsZS1kZWJvdW5jZSc7XG5pbXBvcnQge2lzTnVsbE9yVW5kZWZpbmVkfSBmcm9tIFwidXRpbFwiO1xuXG5jb25zdCBtb21lbnQgPSByZXF1aXJlKFwibW9tZW50XCIpO1xuXG52YXIgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTtcbnZhciByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuXG5yb3V0ZXIucG9zdCgnL3VwZGF0ZScsIGFzeW5jIChyZXE6IEV4cHJlc3MuUmVxdWVzdCwgcmVzKSA9PiB7XG5cbiAgICBjb25zdCB1cGRhdGUgPSB0aHJvdHRsZSgxMDAwLCAoKSA9PiB7XG4gICAgICAgIHNldEltbWVkaWF0ZSh1cGRhdGVTdHJlYW1RdWV1ZSk7XG4gICAgfSk7XG5cbiAgICB1cGRhdGUoKTtcblxuICAgIGFzeW5jIGZ1bmN0aW9uIHNlbmREYXRhKCkge1xuICAgICAgICByZXMuc2VuZCh7XG4gICAgICAgICAgICBhdXRoOiB0cnVlLFxuICAgICAgICAgICAgcG9pbnRzOiByZXEudXNlci5wb2ludHMsXG4gICAgICAgICAgICBxdWV1ZTogKGF3YWl0IFN0cmVhbVF1ZXVlLmN1cnJlbnRBbmROZXh0U3RyZWFtcygpKSxcbiAgICAgICAgICAgIHZpZXdlcnM6IChhd2FpdCBVc2VyLnZpZXdlcnMoKSksXG4gICAgICAgICAgICBtb3N0UG9pbnRzOiAoYXdhaXQgVXNlci5tb3N0UG9pbnRzKCkpLFxuICAgICAgICAgICAgbW9zdFBsYWNlOiAoYXdhaXQgVXNlci5tb3N0UGxhY2UoKSksXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChyZXEuaXNBdXRoZW50aWNhdGVkKCkpIHtcblxuICAgICAgICAvL2NoZWNrIGlmIHN0cmVhbSBpcyBvbmxpbmVcbiAgICAgICAgbGV0IGN1cnJlbnQgPSBhd2FpdCBTdHJlYW1RdWV1ZS5jdXJyZW50U3RyZWFtKCk7XG5cbiAgICAgICAgLy9DaGVjayBpZiBzdHJlYW0gYW5kIGlzIG5vdCBzZWxmIHN0cmVhbVxuICAgICAgICBpZiAoY3VycmVudCA9PSB1bmRlZmluZWQgfHwgY3VycmVudC51c2VyLmlkID09PSByZXEudXNlci5pZCkge1xuICAgICAgICAgICAgYXdhaXQgc2VuZERhdGEoKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBpc09ubGluZSA9IGF3YWl0IFN0cmVhbVF1ZXVlLmlzQ3VycmVudE9ubGluZShjdXJyZW50LnVzZXIudXNlcm5hbWUpO1xuXG4gICAgICAgIC8vQ2hlY2sgaWYgc3RyZWFtIGlzIG9ubGluZVxuICAgICAgICBpZiAoIWlzT25saW5lKSB7XG4gICAgICAgICAgICBhd2FpdCBzZW5kRGF0YSgpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IG5ld0RhdGUgPSBtb21lbnQoKTtcblxuICAgICAgICBsZXQgbGFzdFVwZGF0ZTogRGF0ZSA9IHJlcS51c2VyLmxhc3RVcGRhdGVUaW1lKCk7XG5cbiAgICAgICAgLy9JZiBsYXN0VXBkYXRlIHdhcyBvbmUgbWludXRlcyBvciBsZXNzIGFnb1xuICAgICAgICBpZiAobW9tZW50KGxhc3RVcGRhdGUpLmFkZCgxLCBcIm1pbnV0ZXNcIikgPj0gbmV3RGF0ZSkge1xuICAgICAgICAgICAgYXdhaXQgcmVxLnVzZXIuY2hhbmdlUG9pbnRzKChuZXdEYXRlLnRvRGF0ZSgpLmdldFRpbWUoKSAtIGxhc3RVcGRhdGUuZ2V0VGltZSgpKSAvIDEwMDApO1xuICAgICAgICAgICAgcmVxLnVzZXIubGFzdFVwZGF0ZSA9IG5ld0RhdGUudG9EYXRlKCk7XG4gICAgICAgICAgICBhd2FpdCByZXEudXNlci5zYXZlKCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXEudXNlci5sYXN0VXBkYXRlID0gbmV3RGF0ZS50b0RhdGUoKTtcbiAgICAgICAgICAgIGF3YWl0IHJlcS51c2VyLnNhdmUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHNlbmREYXRhKCk7XG4gICAgICAgIHJldHVybjtcblxuXG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICAvL05vdCBhdXRoXG4gICAgICAgIHJldHVybiByZXMuc2VuZCh7YXV0aDogZmFsc2V9KTtcbiAgICB9XG5cbn0pO1xuXG5yb3V0ZXIucG9zdCgnL2FkZCcsIGFzeW5jIChyZXE6IEV4cHJlc3MuUmVxdWVzdCwgcmVzKSA9PiB7XG5cbiAgICBpZiAocmVxLmlzQXV0aGVudGljYXRlZCgpKSB7XG5cbiAgICAgICAgLy9DaGVjayBpZiBxdWV1ZSBpcyBlbXB0eVxuICAgICAgICBsZXQgY29zdCA9IChhd2FpdCBTdHJlYW1RdWV1ZS5pc0VtcHR5KCkpID8gMCA6IDEwMDA7XG5cbiAgICAgICAgLy9DaGVjayBpZiBlbm91Z2ggcG9pbnRzRnVuY1xuICAgICAgICBsZXQgcG9pbnRzID0gKGF3YWl0IHJlcS51c2VyLnBvaW50cyk7XG4gICAgICAgIGlmIChwb2ludHMgPCBjb3N0KSB7XG4gICAgICAgICAgICAvL05vIGVub3VnaCBwb2ludFxuICAgICAgICAgICAgcmVzLnNlbmQoe2F1dGg6IHRydWUsIGVub3VnaDogZmFsc2UsIHBvaW50cywgY29zdH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgLy9Fbm91Z2ggcG9pbnRcbiAgICAgICAgICAgIGxldCBzdHJlYW0gPSBuZXcgU3RyZWFtUXVldWUoKTtcbiAgICAgICAgICAgIHN0cmVhbS5hbW91bnQgPSBjb3N0O1xuICAgICAgICAgICAgc3RyZWFtLnRpbWUgPSA2MCAqIDEwO1xuXG4gICAgICAgICAgICBzdHJlYW0udXNlciA9IHJlcS51c2VyO1xuXG4gICAgICAgICAgICBsZXQgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxTdHJlYW1RdWV1ZT4gPSBnZXREQkNvbm5lY3Rpb24oKS5nZXRSZXBvc2l0b3J5KFN0cmVhbVF1ZXVlKTtcbiAgICAgICAgICAgIGF3YWl0IHJlcG9zaXRvcnkuc2F2ZShzdHJlYW0pO1xuXG4gICAgICAgICAgICByZXEudXNlci5zdHJlYW1RdWV1ZS5wdXNoKHN0cmVhbSk7XG5cbiAgICAgICAgICAgIC8vQ2hhbmdlIHBvaW50c1xuICAgICAgICAgICAgYXdhaXQgcmVxLnVzZXIuY2hhbmdlUG9pbnRzKC1jb3N0KTtcblxuICAgICAgICAgICAgLy9EaXNjb3JkXG4gICAgICAgICAgICAoKCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgLy9TdG9wIHNwYW0sIG9ubHkgb25lIG1lc3NhZ2UgcGVyIGhvdXJcbiAgICAgICAgICAgICAgICBpZiAoZ2xvYmFsWydkaXNjb3JkQW50aVNwYW1EYXRlJ10gPj0gbW9tZW50KCkuc3VidHJhY3QoXCIxXCIsIFwiaG91clwiKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgZ2xvYmFsWydkaXNjb3JkQW50aVNwYW1EYXRlJ10gPSBtb21lbnQoKTtcblxuXG4gICAgICAgICAgICAgICAgY29uc3QgY2hhbm5lbCA9IHJlcS5kaXNjb3JkLmNoYW5uZWxzLmZpbmQoKGNoKSA9PiBjaC5pZCA9PT0gJzYxNzgzNTg0MDA2ODEyNDY5MicpO1xuXG4gICAgICAgICAgICAgICAgaWYgKCFjaGFubmVsKSByZXR1cm47XG5cblxuICAgICAgICAgICAgICAgIGNoYW5uZWxbJ3NlbmQnXShgXG4gIFVuIHN0cmVhbSB2aWVucyBkJ8OqdHJlIGxhbmPDqSBzdXIgU3RyZWFtUnVubmVycyAhIFZhIHZpdGUgcsOpY3Vww6lyZXIgZGVzIHBvaW50cyAhXG4gIGh0dHBzOi8vc3RyZWFtcnVubmVycy5mci9gKTtcbiAgICAgICAgICAgIH0pKCk7XG5cbiAgICAgICAgICAgIHJlcy5zZW5kKHthdXRoOiB0cnVlLCBlbm91Z2g6IHRydWV9KTtcbiAgICAgICAgfVxuXG5cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIC8vTm90IGF1dGhcbiAgICAgICAgcmVzLnNlbmQoe2F1dGg6IGZhbHNlfSk7XG5cbiAgICB9XG5cbn0pO1xuXG5yb3V0ZXIucG9zdCgnL2RlbGV0ZScsIGFzeW5jIChyZXE6IEV4cHJlc3MuUmVxdWVzdCwgcmVzKSA9PiB7XG5cbiAgICBpZiAocmVxLmlzVW5hdXRoZW50aWNhdGVkKCkpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zZW5kKHthdXRoOiBmYWxzZX0pO1xuICAgIH1cblxuICAgIC8vR2V0IGlkXG4gICAgY29uc3QgaWQgPSByZXFbJ2JvZHknXS5pZDtcblxuICAgIGlmIChpZCA9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zZW5kKHthdXRoOiB0cnVlLCBlcnJvcjogdHJ1ZSwgZXJyb3JNZXNzYWdlOiBcIkltcG9zc2libGUgZGUgdHJvdXZlciBsYSBwbGFjZVwifSk7XG4gICAgfVxuXG4gICAgLy9HZXQgc3RyZWFtXG4gICAgY29uc3QgcmVwbyA9IGdldERCQ29ubmVjdGlvbigpLmdldFJlcG9zaXRvcnkoU3RyZWFtUXVldWUpO1xuICAgIGNvbnN0IHN0cmVhbSA9IGF3YWl0IHJlcG8uY3JlYXRlUXVlcnlCdWlsZGVyKFwicXVldWVcIilcbiAgICAgICAgLmxlZnRKb2luQW5kU2VsZWN0KFwicXVldWUudXNlclwiLCBcInVzZXJcIilcbiAgICAgICAgLndoZXJlKFwicXVldWUuaWQgPSA6aWRcIiwge2lkfSlcbiAgICAgICAgLmFuZFdoZXJlKFwidXNlci5pZCA9IDp1c2VyaWRcIiwge3VzZXJpZDogcmVxLnVzZXIuaWR9KVxuICAgICAgICAuZ2V0T25lKCk7XG5cbiAgICBpZiAoc3RyZWFtID09IHVuZGVmaW5lZCB8fCBzdHJlYW0udXNlci5pZCAhPT0gcmVxLnVzZXIuaWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zZW5kKHthdXRoOiB0cnVlLCBlcnJvcjogdHJ1ZSwgZXJyb3JNZXNzYWdlOiBcIkltcG9zc2libGUgZGUgdHJvdXZlciBsYSBwbGFjZVwifSk7XG4gICAgfVxuXG4gICAgaWYgKChhd2FpdCBTdHJlYW1RdWV1ZS5jdXJyZW50U3RyZWFtKCkpLmlkID09PSBzdHJlYW0uaWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zZW5kKHthdXRoOiB0cnVlLCBlcnJvcjogdHJ1ZSwgZXJyb3JNZXNzYWdlOiBcIk9uIG5lIHBldXQgcGFzIHN1cHByaW1lciBzaSBvbiDDoCBsYSBwcmVtacOocmUgcGxhY2VcIn0pO1xuICAgIH1cblxuICAgIC8vRGVsZXRlIHN0cmVhbVxuICAgIGF3YWl0IHJlcG8ucmVtb3ZlKHN0cmVhbSk7XG5cbiAgICAvL1JlZnVuZFxuICAgIGF3YWl0IHJlcS51c2VyLmNoYW5nZVBvaW50cyhzdHJlYW0uYW1vdW50KTtcbiAgICBhd2FpdCByZXEudXNlci5zYXZlKCk7XG5cbiAgICByZXR1cm4gcmVzLnNlbmQoe2F1dGg6IHRydWUsIGVycm9yOiBmYWxzZX0pO1xuXG59KTtcblxucm91dGVyLnBvc3QoJy9za2lwJywgYXN5bmMgKHJlcTogRXhwcmVzcy5SZXF1ZXN0LCByZXMpID0+IHtcblxuICAgIGlmIChyZXEuaXNBdXRoZW50aWNhdGVkKCkgJiYgcmVxLnVzZXIubW9kZXJhdG9yKSB7XG5cblxuICAgICAgICBsZXQgY3VycmVudFN0cmVhbSA9IGF3YWl0IFN0cmVhbVF1ZXVlLmN1cnJlbnRTdHJlYW0oKTtcblxuICAgICAgICBpZiAoY3VycmVudFN0cmVhbSAhPSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGN1cnJlbnRTdHJlYW0uY3VycmVudCA9IGN1cnJlbnRTdHJlYW0udGltZTtcbiAgICAgICAgICAgIGF3YWl0IGdldERCQ29ubmVjdGlvbigpLmdldFJlcG9zaXRvcnkoU3RyZWFtUXVldWUpLnNhdmUoY3VycmVudFN0cmVhbSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXMuc2VuZChcIlN0cmVhbSBza2lwcMOpXCIpO1xuXG5cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAzKTtcbiAgICAgICAgcmVzLnNlbmQoXCJWb3VzIG4nYXZleiBwYXMgbGUgZHJvaXQgZGUgZmFpcmUgw6dhICFcIik7XG4gICAgfVxuXG5cbn0pO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHJvdXRlcjsiXX0=